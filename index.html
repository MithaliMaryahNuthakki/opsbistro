<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BISTRO FLOW: V12 DYNAMIC OPS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;900&display=swap" rel="stylesheet">
    <style>
        :root { 
            --bar: #f59e0b; --booth: #0ea5e9; --main: #10b981; --suite: #a855f7; --patio: #64748b; 
            --bg: #f1f5f9; --sidebar: #ffffff; --text-main: #0f172a; --card: #ffffff; --border: #cbd5e1;
            --ops-btn: #e2e8f0; --ops-text: #0f172a;
            --queue-header-bg: #f8fafc;
            
            --contract-bg: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%);
            --contract-text: #1e1b4b;
            --invite-bg: #ffffff;
            --invite-text: #0f172a;
            --invite-border: #6366f1;
        }
        body.dark-mode { 
            --bg: #020617; --sidebar: #0f172a; --text-main: #f8fafc; --card: #1e293b; --border: #334155; 
            --ops-btn: #1e293b; --ops-text: #ffffff;
            --queue-header-bg: #1e293b;
            
            --contract-bg: linear-gradient(135deg, #1e1b4b 0%, #312e81 100%);
            --contract-text: #f8fafc;
            --invite-bg: #1e293b;
            --invite-text: #ffffff;
            --invite-border: #4f46e5;
        }

        body { background: var(--bg); color: var(--text-main); font-family: 'Inter', sans-serif; height: 100vh; overflow: hidden; display: flex; flex-direction: column; transition: background 0.3s, color 0.3s; }
        header { background: var(--sidebar); border-bottom: 1px solid var(--border); flex-shrink: 0; z-index: 50; }
        main { display: flex; flex: 1; overflow: hidden; width: 100%; }
        aside { background: var(--sidebar); border-color: var(--border); display: flex; flex-direction: column; flex-shrink: 0; width: 360px; transition: 0.3s; }
        #lobby-list { flex: 1; overflow-y: auto; padding: 1rem; }
        
        .queue-header { 
            background: var(--queue-header-bg); 
            border-bottom: 1px solid var(--border); 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 1rem; 
            transition: background 0.3s; 
        }
        .queue-toggle { background: #ef4444; color: white; font-size: 9px; font-weight: 900; padding: 4px 12px; border-radius: 8px; cursor: pointer; border: none; transition: 0.2s; }
        .queue-toggle.on { background: #10b981; }
        .intake-cost-warning { font-size: 8px; color: #ef4444; font-weight: 900; margin-right: 8px; text-transform: uppercase; animation: pulse 1s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

        .lobby-card { cursor: grab; margin-bottom: 1rem; border-radius: 1rem; border: 1px solid var(--border); position: relative; transition: 0.2s; }
        .vip-card-filled { background: var(--glow-color) !important; color: white !important; animation: vip-pulse 2s infinite ease-in-out; box-shadow: 0 0 25px var(--glow-color); }
        @keyframes vip-pulse { 0%, 100% { filter: brightness(1); transform: scale(1); } 50% { filter: brightness(1.3); transform: scale(0.98); } }
        
        #floor-section { flex: 1; display: flex; flex-direction: column; overflow: hidden; background: var(--bg); }
        #floor-plan { flex: 1; display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); grid-auto-rows: min-content; gap: 1.5rem; padding: 2rem; overflow: hidden; justify-content: center; }
        .table-unit { width: 100%; min-height: 140px; position: relative; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 24px; background: var(--card); border: 4px solid transparent; box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: 0.3s; padding: 8px; }
        #patio-zone { padding: 1rem; border-top: 1px dashed var(--border); margin-top: auto; display: flex; justify-content: center; background: rgba(0,0,0,0.02); min-height: 120px; }
        .patio-unit { width: 320px; min-height: 100px; }
        .mismatch-badge { background: #ef4444; color: white; font-size: 10px; padding: 4px 10px; border-radius: 99px; font-weight: 900; position: absolute; top: -12px; z-index: 20; animation: bounce 1s infinite; box-shadow: 0 4px 10px rgba(239, 68, 68, 0.4); }
        .patio-badge { background: #64748b; border: 1px solid white; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
        .vendor-panel { background: rgba(128,128,128,0.1); border-radius: 1.5rem; padding: 1rem; border: 1px solid var(--border); }
        .vendor-card { padding: 1rem; border-radius: 1.25rem; background: var(--card); border: 1px solid var(--border); margin-bottom: 0.75rem; transition: 0.3s; }
        .vendor-btn { width: 100%; margin-top: 0.5rem; padding: 0.75rem; background: #6366f1; color: white; border-radius: 0.75rem; font-size: 11px; font-weight: 900; text-transform: uppercase; }
        .ops-btn { width: 100%; display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: var(--ops-btn); color: var(--ops-text); border-radius: 1rem; font-size: 12px; font-weight: 900; text-transform: uppercase; transition: 0.3s; border: 2px solid var(--border); }
        .ops-btn-active { background: #10b981 !important; border-color: #34d399 !important; color: white !important; box-shadow: 0 0 15px rgba(16, 185, 129, 0.4); }
        #notification-toast { position: fixed; bottom: 30px; left: 50%; transform: translate(-50%, 200%); padding: 1rem 2.5rem; background: #0f172a; color: white; border-radius: 99px; font-weight: 800; transition: 0.4s; z-index: 9999; border: 2px solid #ef4444; }
        #notification-toast.show { transform: translate(-50%, 0); }
        .table-progress-container { width: 100%; height: 6px; background: rgba(0,0,0,0.1); border-radius: 99px; margin-top: 4px; overflow: hidden; }
        .table-progress-bar { height: 100%; background: #10b981; transition: width 1s linear; }
        .cleaning-bar { background: #f59e0b !important; }
        #theme-toggle { cursor: pointer; padding: 8px; border-radius: 12px; border: 1px solid var(--border); background: var(--card); transition: 0.2s; color: var(--text-main); }
        .build-area { background: var(--bg); border-top: 1px solid var(--border); transition: 0.3s; }
        select { background: var(--card) !important; color: var(--text-main) !important; border: 1px solid var(--border) !important; }

        .contract-card { background: var(--contract-bg); color: var(--contract-text); border: 2px solid #6366f1; border-radius: 1rem; padding: 1rem; margin-bottom: 1rem; position: relative; overflow: hidden; transition: background 0.3s, color 0.3s; }
        .contract-invite-card { background: var(--invite-bg); color: var(--invite-text); border: 2px solid var(--invite-border); border-radius: 0.75rem; padding: 0.75rem; margin-bottom: 0.5rem; transition: background 0.3s, color 0.3s; }
        .contract-progress { height: 4px; background: rgba(0,0,0,0.1); border-radius: 2px; margin-top: 8px; }
        body.dark-mode .contract-progress { background: rgba(255,255,255,0.1); }
        .contract-fill { height: 100%; background: #fbbf24; transition: width 0.3s; }
        .contract-timer-warning { font-size: 10px; font-weight: 900; color: #ef4444; margin-top: 4px; display: block; }
    </style>
</head>
<body class="dark-mode">

    <div id="notification-toast">ACTION BLOCKED</div>

    <header class="p-4 flex justify-between items-center shadow-md">
        <div class="flex items-center gap-6">
            <div>
                <h1 class="text-2xl font-black italic uppercase tracking-tighter leading-none">Bistro <span class="text-amber-500">Flow</span></h1>
                <div id="round-indicator" class="text-[10px] font-black text-indigo-500 uppercase tracking-widest mt-1">GLOBAL OPS V12</div>
            </div>
            <div class="bg-indigo-600 px-4 py-2 rounded-xl">
                <span class="text-[9px] block text-indigo-200 font-black uppercase">Operation Phase</span>
                <span id="round-display-text" class="text-xl text-white font-black uppercase tracking-tighter">Round 0</span>
            </div>
        </div>
        
        <div class="flex items-center gap-10 font-mono">
            <div class="text-right">
                <span class="text-[9px] block opacity-50 uppercase font-black">Storage Capacity</span>
                <span id="stock-text" class="text-3xl text-blue-400 font-black">40</span><span id="max-stock-text" class="text-lg opacity-40 font-black">/100</span>
            </div>
            <div class="text-right border-l border-slate-700 pl-10">
                <span class="text-[9px] block opacity-50 uppercase font-black">Capital</span>
                <span id="score-text" class="text-2xl text-emerald-400 font-black">$2,000</span>
            </div>
            <div class="text-right border-l border-slate-700 pl-10">
                <span class="text-[9px] block opacity-50 uppercase font-black">Shift</span>
                <span id="timer-text" class="text-2xl text-amber-400 font-black">02:00</span>
            </div>
            <button id="theme-toggle" onclick="toggleTheme()" class="text-xl">ðŸŒ™</button>
        </div>
    </header>

    <main>
        <aside class="border-r">
            <div class="queue-header">
                <h2 class="text-[11px] font-black opacity-30 uppercase tracking-[0.2em]">Inbound Queue</h2>
                <div class="flex items-center">
                    <span id="intake-warning" class="intake-cost-warning hidden">Paused: -$5/s</span>
                    <button id="queue-toggle-btn" onclick="toggleIntake()" class="queue-toggle on">INTAKE: ON</button>
                </div>
            </div>
            <div id="lobby-list"></div>
            
            <div class="p-6 build-area space-y-2">
                <button onclick="upgradeStorage()" class="w-full py-3 bg-amber-500 text-black border-2 border-amber-400 rounded-xl text-[10px] font-black uppercase shadow-[0_0_15px_rgba(245,158,11,0.3)]">Expand Storage +50 ($3,000)</button>
                <div class="flex gap-2">
                    <select id="build-type" onchange="updateBuildPrice()" class="flex-1 rounded-lg p-2 text-[10px] font-bold">
                        <option value="BAR">BAR STATION</option>
                        <option value="BOOTH">BOOTH UNIT</option>
                        <option value="DINING">DINING TABLE</option>
                        <option value="SUITE">SUITE</option>
                    </select>
                    <select id="build-cap" onchange="updateBuildPrice()" class="w-20 rounded-lg p-2 text-[10px] font-bold">
                        <option value="2">2P</option>
                        <option value="4">4P</option>
                        <option value="6">6P</option>
                        <option value="8">8P</option>
                    </select>
                </div>
                <button id="build-btn" onclick="addTable()" class="w-full py-3 bg-indigo-600 text-white rounded-xl text-[10px] font-black uppercase shadow-lg">Build Station ($5,000)</button>
            </div>
        </aside>

        <section id="floor-section">
            <div id="floor-plan"></div>
            <div id="patio-zone"></div>
        </section>

        <aside class="border-l">
            <h2 class="text-[11px] font-black opacity-30 uppercase tracking-[0.2em] p-4 text-center border-b">Market & Ops</h2>
            <div class="p-4 flex-1 overflow-y-auto">
                <div class="mb-6 space-y-2">
                    <h3 class="text-[10px] font-black opacity-30 uppercase text-center mb-2">Systems Override</h3>
                    <div class="grid grid-cols-2 gap-2">
                        <button id="clean-btn" onclick="toggleCleaning()" class="ops-btn">Wash <span>OFF</span></button>
                        <button id="surge-btn" onclick="toggleSurge()" class="ops-btn">Surge <span>OFF</span></button>
                    </div>
                </div>

                <div id="catering-zone" class="mb-6">
                    <h3 class="text-[10px] font-black opacity-40 uppercase mb-2">Active Contracts</h3>
                    <div id="active-contracts" class="space-y-2"></div>
                </div>
                
                <div id="pending-orders" class="mb-4 space-y-2"></div>
                <div id="vendor-list" class="vendor-panel"></div>
            </div>
        </aside>
    </main>

    <div id="start-screen" class="fixed inset-0 bg-slate-950 z-[9000] flex items-center justify-center">
        <div class="text-center p-12 bg-slate-900 rounded-[3rem] border border-white/10 shadow-2xl max-w-sm w-full">
            <input type="text" id="op-name" placeholder="OPERATOR ID" class="w-full p-4 mb-4 border border-slate-700 rounded-2xl text-center font-bold bg-slate-800 text-white outline-none">
            <button onclick="initGame()" class="w-full py-5 bg-indigo-600 text-white rounded-2xl font-black uppercase tracking-widest shadow-xl">Launch System</button>
        </div>
    </div>

    <div id="audit-screen" class="fixed inset-0 bg-black/95 z-[10000] hidden items-center justify-center p-4 text-white">
        <div class="bg-slate-900 p-10 rounded-[3rem] w-full max-w-md border border-white/5 shadow-2xl">
            <h2 id="audit-title" class="text-3xl font-black italic mb-2 text-indigo-400">SHIFT LOGS</h2>
            <div id="audit-details" class="space-y-4 mb-10 text-sm font-mono bg-black/20 p-6 rounded-2xl"></div>
            <button onclick="startNextRound()" id="accept-results-btn" class="w-full py-5 bg-emerald-600 text-white font-black rounded-2xl uppercase shadow-xl">Accept Results</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDeQSmaXHZ7fR_YQ4kIzn7hiV3g4kxmTf45I",
            authDomain: "bistroflow-c27e6.firebaseapp.com",
            projectId: "bistroflow-c27e6",
            storageBucket: "bistroflow-c27e6.firebasestorage.app",
            messagingSenderId: "130551151404",
            appId: "1:130551151404:web:7ff8d3073d6eaf05160a89"
        };
        
        let db;
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
        } catch (e) { console.warn("Firebase failed to load."); }

        let score = 2000, time = 120, stock = 40, maxStock = 100, currentRound = 0, opName = "";
        let guests = [], pendingOrders = [], active = false, intakeActive = true;
        let isCleaning = false, isSurge = false;
        let stats = { revenue: 0, penalty: 0, fines: 0 };
        let activeContracts = [];

        const ROUND_CONFIG = {
            0: { time: 120, label: "Round 0: Trial" },
            1: { time: 240, label: "Round 1" },
            2: { time: 300, label: "Round 2" },
            3: { time: 360, label: "Round 3" },
            4: { time: 180, label: "Round 4: Rapid Fire" }
        };

        let vendorData = [
            { name: "Local Hub", basePrice: 100, baseLead: 15, moq: 10 },
            { name: "Global Cargo", basePrice: 85, baseLead: 45, moq: 60 }
        ];

        const SECTIONS = { 
            BAR: { color: '#f59e0b' }, BOOTH: { color: '#0ea5e9' }, 
            DINING: { color: '#10b981' }, SUITE: { color: '#a855f7' }, PATIO: { color: '#64748b' } 
        };

        let TABLES = [
            { id: 1, type: 'BAR', cap: 2, parties: [], busing: 0, busTotal: 0 },
            { id: 2, type: 'BOOTH', cap: 4, parties: [], busing: 0, busTotal: 0 },
            { id: 3, type: 'DINING', cap: 6, parties: [], busing: 0, busTotal: 0 },
            { id: 99, type: 'PATIO', cap: 12, parties: [], busing: 0, busTotal: 0 }
        ];

        window.initGame = () => {
            opName = document.getElementById('op-name').value.toUpperCase() || "AGENT";
            document.getElementById('start-screen').style.display = 'none';
            active = true;
            spawnLogic();
            spawnContract();
            renderVendors();
            updateBuildPrice();
            render();
            saveGame();
        };

        window.toggleIntake = () => {
            intakeActive = !intakeActive;
            const btn = document.getElementById('queue-toggle-btn');
            btn.innerText = intakeActive ? "INTAKE: ON" : "INTAKE: OFF";
            btn.classList.toggle('on', intakeActive);
            document.getElementById('intake-warning').classList.toggle('hidden', intakeActive);
            showToast(intakeActive ? "SYSTEM ACCEPTING GUESTS" : "INTAKE HALTED (-$5/s)");
        };

        window.toggleTheme = () => {
            const body = document.body;
            const btn = document.getElementById('theme-toggle');
            if (body.classList.contains('dark-mode')) {
                body.classList.remove('dark-mode');
                btn.innerText = "â˜€ï¸";
            } else {
                body.classList.add('dark-mode');
                btn.innerText = "ðŸŒ™";
            }
        };

        window.updateBuildPrice = () => {
            const cap = parseInt(document.getElementById('build-cap').value);
            const cost = 3000 + (cap * 1000);
            document.getElementById('build-btn').innerText = `Build Station ($${cost.toLocaleString()})`;
        };

        window.spawnContract = () => {
            if(!active) return;
            const target = 20 + (currentRound * 15);
            const payout = target * 250;
            const newContract = {
                id: Date.now(),
                target: target,
                current: 0,
                payout: payout,
                accepted: false,
                expires: 25,
                timer: 60 // 1 MINUTE TIMER APPENDED
            };
            activeContracts.push(newContract);
            render();
            setTimeout(spawnContract, 35000);
        };

        window.acceptContract = (id) => {
            const c = activeContracts.find(x => x.id === id);
            if(c) {
                c.accepted = true;
                score += (c.payout * 0.4); 
                showToast("CONTRACT SIGNED: 60s TO FINISH");
                render();
            }
        };

        window.fulfillContract = (id) => {
            const c = activeContracts.find(x => x.id === id);
            if(!c || stock <= 0) return;
            const needed = c.target - c.current;
            const canGive = Math.min(stock, needed);
            stock -= canGive;
            c.current += canGive;
            if(c.current >= c.target) {
                score += (c.payout * 0.6); 
                stats.revenue += c.payout;
                activeContracts = activeContracts.filter(x => x.id !== id);
                showToast("CONTRACT COMPLETED!");
            }
            render();
        };

        window.buyStock = (cost, amt, lead, btn) => {
            if(stock + amt > maxStock) { showToast(`STORAGE FULL: MAX ${maxStock} UNITS`); return; }
            if(score >= cost) {
                score -= cost;
                pendingOrders.push({ amt, remaining: lead });
                if(btn) {
                    btn.innerText = "ORDER APPROVED";
                    btn.disabled = true;
                    btn.style.opacity = "0.5";
                }
                render();
            } else showToast("INSUFFICIENT CAPITAL");
        };

        window.upgradeStorage = () => {
            if(score >= 3000) { score -= 3000; maxStock += 50; render(); } else showToast("NEED $3,000");
        };

        window.handleDrop = (gId, tId) => {
            const g = guests.find(x => x.id == gId);
            const t = TABLES.find(x => x.id == tId);
            if(!t || !g) return;
            const usage = Math.ceil(g.size * g.appetite);
            const requiredStock = g.isVIP ? usage * 2 : usage; 
            const curSeated = t.parties.reduce((s,p)=>s+p.size, 0);
            if(curSeated + g.size > t.cap) { showToast("OVER CAPACITY"); return; }
            if(t.busing > 0) { showToast("TABLE IS DIRTY"); return; }
            if(t.type !== 'PATIO' && t.parties.length > 0) { showToast("TABLE OCCUPIED"); return; }
            if(stock < requiredStock) { showToast(`NEED ${requiredStock} UNITS`); return; }
            stock -= requiredStock; 
            let pay = g.val, mismatch = false, patioMismatch = false;
            if(t.type !== g.pref) { 
                mismatch = true;
                if(t.type === 'PATIO') {
                    pay *= 0.8; patioMismatch = true;
                    stats.penalty += (g.val * 0.2);
                } else {
                    pay *= 0.7;
                    stats.penalty += (g.val * 0.3);
                }
            }
            t.parties.push({ ...g, rem: 40, total: 40, pay, mismatch, patioMismatch });
            guests = guests.filter(x => x.id != gId);
            render();
        };

        window.startNextRound = () => { 
            guests = []; 
            TABLES.forEach(t => { 
                t.parties = []; 
                t.busing = 0; 
                t.busTotal = 0;
            });
            if (score < 0) {
                score = 1500; 
                showToast(`CORPORATE BAILOUT: DEBT CLEARED, +$1500`);
            }
            if(currentRound === 0) {
                score = 2000; stock = 40; maxStock = 100;
                pendingOrders = [];
            }
            currentRound++;
            if (currentRound > 4) {
                showToast("ALL OPERATIONS COMPLETE");
                localStorage.removeItem('bistro_flow_save');
                location.reload();
                return;
            }
            time = ROUND_CONFIG[currentRound].time;
            stats = { revenue:0, penalty:0, fines:0 };
            activeContracts = [];
            document.getElementById('audit-screen').style.display = 'none';
            active = true;
            intakeActive = true;
            const btn = document.getElementById('queue-toggle-btn');
            btn.innerText = "INTAKE: ON"; btn.classList.add('on');
            document.getElementById('intake-warning').classList.add('hidden');
            spawnLogic();
            spawnContract();
            saveGame();
        };

        window.addTable = () => { 
            const cap = parseInt(document.getElementById('build-cap').value);
            const cost = 3000 + (cap * 1000); 
            if(score >= cost) { 
                score -= cost; 
                TABLES.push({ id: Date.now(), type: document.getElementById('build-type').value, cap: cap, parties: [], busing: 0, busTotal: 0 }); 
                render(); 
            } else showToast(`NEED $${cost} FOR ${cap} SEATS`); 
        };
        
        window.toggleCleaning = () => { 
            isCleaning = !isCleaning; 
            document.getElementById('clean-btn').classList.toggle('ops-btn-active', isCleaning);
            document.getElementById('clean-btn').querySelector('span').innerText = isCleaning ? "ACTIVE" : "OFF";
        };

        window.toggleSurge = () => { 
            isSurge = !isSurge; 
            document.getElementById('surge-btn').classList.toggle('ops-btn-active', isSurge);
            document.getElementById('surge-btn').querySelector('span').innerText = isSurge ? "ACTIVE" : "OFF";
        };

        window.showToast = (m) => { 
            const t = document.getElementById('notification-toast'); 
            t.innerText = m; 
            t.classList.add('show'); 
            setTimeout(()=>t.classList.remove('show'), 2000); 
        };

        function saveGame() {
            const gameState = { score, time, stock, maxStock, currentRound, opName, TABLES, pendingOrders, guests, activeContracts, intakeActive };
            localStorage.setItem('bistro_flow_save', JSON.stringify(gameState));
        }

        function loadGame() {
            const saved = localStorage.getItem('bistro_flow_save');
            if (saved) {
                const data = JSON.parse(saved);
                score = data.score; time = data.time; stock = data.stock;
                maxStock = data.maxStock; currentRound = data.currentRound;
                opName = data.opName; TABLES = data.TABLES;
                pendingOrders = data.pendingOrders || []; guests = data.guests || [];
                activeContracts = data.activeContracts || [];
                intakeActive = data.intakeActive !== undefined ? data.intakeActive : true;
                document.getElementById('op-name').value = opName;
                return true;
            }
            return false;
        }

        // APPENDED LOGIC: REDUCED SPAWN FREQUENCY (50% SLOWER)
        function spawnLogic() {
            if(!active) return;
            if(intakeActive) {
                const isVIP = Math.random() > 0.85;
                const partySize = [2, 4, 6][Math.floor(Math.random() * 3)];
                const appetite = 1 + (Math.random() * 0.4);
                guests.push({
                    id: Date.now() + Math.random(),
                    pref: Object.keys(SECTIONS)[Math.floor(Math.random() * 4)],
                    size: partySize, appetite: appetite,
                    val: Math.floor(partySize * appetite * 180 * (isVIP ? 2.5 : 1)), 
                    isVIP: isVIP, patience: 100,
                    decay: (currentRound === 4 ? 3.5 : (isVIP ? 2.8 : 1.2 + (currentRound * 0.2)))
                });
                render();
            }
            // Frequency significantly reduced: Base 12s, minimum floor of 5s
            const nextSpawn = currentRound === 4 ? 5000 : Math.max(5000, 12000 - (currentRound * 1500));
            setTimeout(spawnLogic, nextSpawn);
        }

        function tick() {
            if(!active) return;
            time--;
            if(isCleaning) score -= 5;
            if(isSurge) score -= 15;
            if(!intakeActive) { score -= 5; stats.fines += 5; }

            // UPDATED CONTRACT TICKER LOGIC
            for (let i = activeContracts.length - 1; i >= 0; i--) {
                let c = activeContracts[i];
                if(!c.accepted) {
                    c.expires--;
                    if(c.expires <= 0) activeContracts.splice(i, 1);
                } else {
                    // ACCEPTED CONTRACT TIMER
                    c.timer--;
                    if(c.timer <= 0) {
                        const fine = Math.floor(c.payout * 1.5);
                        score -= fine;
                        stats.fines += fine;
                        activeContracts.splice(i, 1);
                        showToast(`CONTRACT BREACHED! -$${fine.toLocaleString()}`);
                    }
                }
            }

            pendingOrders.forEach((o, i) => {
                o.remaining--;
                if(o.remaining <= 0) { 
                    stock = Math.min(maxStock, stock + o.amt); 
                    pendingOrders.splice(i, 1); 
                }
            });
            TABLES.forEach(t => {
                if(t.parties.length === 0 && t.busing > 0) t.busing -= (isCleaning ? 4 : 1);
                for (let i = t.parties.length - 1; i >= 0; i--) {
                    let p = t.parties[i];
                    p.rem -= (isSurge ? 4 : 1);
                    if(p.rem <= 0) {
                        score += p.pay; stats.revenue += p.pay;
                        t.parties.splice(i, 1);
                        if(t.parties.length === 0) { t.busing = 25; t.busTotal = 25; }
                    }
                }
            });
            guests.forEach((g, i) => {
                g.patience -= g.decay;
                if(g.patience <= 0) { 
                    const penalty = currentRound > 1 ? 1000 : 500;
                    guests.splice(i, 1); score -= penalty; stats.fines += penalty; 
                    showToast(`WALK OUT LOSS (-$${penalty})`); 
                }
            });
            if(time % 10 === 0) renderVendors();
            if(time <= 0) endRound();
            saveGame(); 
            render();
        }
        setInterval(tick, 1000);

        function renderVendors() {
            const container = document.getElementById('vendor-list');
            container.innerHTML = vendorData.map(v => {
                const currentPrice = Math.floor(v.basePrice * (0.95 + Math.random() * 0.1));
                const currentLead = Math.max(5, Math.floor(v.baseLead + (Math.random() * 10 - 5)));
                const totalCost = currentPrice * v.moq;
                return `
                <div class="vendor-card">
                    <div class="flex justify-between font-black text-[12px] uppercase"><span>${v.name}</span><span class="text-emerald-500">$${currentPrice}/u</span></div>
                    <div class="text-[14px] font-bold text-indigo-400 mt-1 uppercase">Lead Time: ${currentLead}s</div>
                    <button onclick="buyStock(${totalCost}, ${v.moq}, ${currentLead}, this)" class="vendor-btn">Buy ${v.moq} Units ($${totalCost})</button>
                </div>`;
            }).join('');
        }

        function render() {
            document.getElementById('score-text').innerText = `$${Math.floor(score).toLocaleString()}`;
            document.getElementById('stock-text').innerText = stock;
            document.getElementById('max-stock-text').innerText = `/${maxStock}`;
            document.getElementById('round-display-text').innerText = ROUND_CONFIG[currentRound]?.label || `Round ${currentRound}`;
            const m = Math.floor(time/60), s = time%60;
            document.getElementById('timer-text').innerText = `${m}:${s.toString().padStart(2,'0')}`;
            
            const qBtn = document.getElementById('queue-toggle-btn');
            if (qBtn) {
                qBtn.innerText = intakeActive ? "INTAKE: ON" : "INTAKE: OFF";
                qBtn.classList.toggle('on', intakeActive);
                document.getElementById('intake-warning').classList.toggle('hidden', intakeActive);
            }

            document.getElementById('active-contracts').innerHTML = activeContracts.map(c => {
                if(!c.accepted) {
                    return `<div class="contract-invite-card">
                        <div class="text-[10px] font-black flex justify-between"><span>NEW CONTRACT</span><span class="text-red-500">${c.expires}s</span></div>
                        <div class="text-[14px] font-black">DELIVER ${c.target} UNITS</div>
                        <button onclick="acceptContract(${c.id})" class="w-full mt-2 py-1 bg-indigo-600 text-white text-[9px] font-black rounded uppercase">Accept +$${(c.payout*0.4).toLocaleString()}</button>
                    </div>`;
                }
                const perc = (c.current / c.target) * 100;
                return `<div class="contract-card">
                    <div class="text-[10px] font-black opacity-60">ACTIVE CATERING</div>
                    <div class="flex justify-between items-end">
                        <span class="text-xl font-black">${c.current}/${c.target}</span>
                        <span class="text-[10px] opacity-60">REMAINING: $${(c.payout*0.6).toLocaleString()}</span>
                    </div>
                    <div class="contract-progress"><div class="contract-fill" style="width:${perc}%"></div></div>
                    <span class="contract-timer-warning">DEADLINE: ${c.timer}s</span>
                    <button onclick="fulfillContract(${c.id})" class="w-full mt-3 py-2 bg-amber-500 text-black text-[10px] font-black rounded-lg uppercase">Unload Stock</button>
                </div>`;
            }).join('');

            document.getElementById('pending-orders').innerHTML = pendingOrders.map(o => `
                <div class="text-[14px] font-black bg-blue-500 text-white p-3 rounded-xl border-b-4 border-blue-700 animate-pulse uppercase">
                    Delivery Inbound: +${o.amt} Units (${o.remaining}s)
                </div>`).join('');

            document.getElementById('lobby-list').innerHTML = guests.map(g => {
                const remSec = Math.max(0, Math.ceil(g.patience / g.decay));
                return `
                <div class="p-4 lobby-card ${g.isVIP?'vip-card-filled':''}" 
                     style="border-left: 10px solid ${SECTIONS[g.pref].color}; --glow-color: ${SECTIONS[g.pref].color}; background-color: ${SECTIONS[g.pref].color}33;" 
                     draggable="true" ondragstart="event.dataTransfer.setData('text', ${g.id})">
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-2xl font-black flex items-center gap-2">
                             ${g.size} <svg class="w-6 h-6 inline-block" fill="currentColor" viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg> 
                             <span class="text-xs opacity-50 uppercase">${g.pref}</span>
                        </span>
                        <div class="text-right">
                             <span class="text-[11px] font-black opacity-100 text-indigo-500 block">NEED: ${g.isVIP?Math.ceil(g.size*g.appetite)*2:Math.ceil(g.size*g.appetite)} UNITS</span>
                             <span class="text-[10px] font-black text-red-500 uppercase">${remSec}s REMAINING</span>
                        </div>
                    </div>
                    <div class="h-2 bg-black/20 rounded-full overflow-hidden"><div class="h-full bg-indigo-600" style="width:${g.patience}%"></div></div>
                </div>`}).join('');

            const drawT = (t) => {
                const cur = t.parties.reduce((s,p)=>s+p.size, 0);
                let badgeHtml = '', progressHtml = '';
                if(t.parties.some(p => p.patioMismatch)) badgeHtml = '<div class="mismatch-badge patio-badge">PATIO MISMATCH</div>';
                else if(t.parties.some(p => p.mismatch)) badgeHtml = '<div class="mismatch-badge">MISMATCH</div>';
                if(t.parties.length > 0) {
                    progressHtml = t.parties.map(p => {
                        const percent = (p.rem / p.total) * 100;
                        return `<div class="w-full mt-2">
                            <div class="flex justify-between text-[8px] font-black text-indigo-500 uppercase"><span>Group (${p.size}P)</span><span>${Math.max(0, p.rem)}s</span></div>
                            <div class="table-progress-container"><div class="table-progress-bar" style="width: ${percent}%"></div></div>
                        </div>`;
                    }).join('');
                } else if (t.busing > 0) {
                    const busPercent = (t.busing / t.busTotal) * 100;
                    progressHtml = `<div class="text-[10px] font-black mt-2 text-amber-500">${Math.max(0, Math.ceil(t.busing / (isCleaning?4:1)))}s</div><div class="table-progress-container"><div class="table-progress-bar cleaning-bar" style="width: ${busPercent}%"></div></div>`;
                }
                return `
                <div class="table-unit ${t.id==99?'patio-unit':''}" style="border-color: ${SECTIONS[t.type].color}; opacity: ${cur>0||t.busing>0?1:0.6}" 
                     ondragover="event.preventDefault()" ondrop="handleDrop(event.dataTransfer.getData('text'), ${t.id})">
                    ${badgeHtml}
                    ${t.busing > 0 ? '<span class="text-[10px] text-amber-500 font-black animate-pulse">CLEANING</span>' : `<span class="text-2xl font-black">${cur}/${t.cap}</span>`}
                    <span class="text-[12px] font-black uppercase text-current mt-1">${t.id==99?'PATIO DECK':t.type}</span>
                    <div class="w-full">${progressHtml}</div>
                </div>`;
            };
            document.getElementById('floor-plan').innerHTML = TABLES.filter(t=>t.id!=99).map(drawT).join('');
            document.getElementById('patio-zone').innerHTML = TABLES.filter(t=>t.id==99).map(drawT).join('');
        }

        async function endRound() {
            active = false; 
            let contractFines = 0;
            activeContracts.forEach(c => {
                if(c.accepted) contractFines += (c.payout * 1.5); 
            });
            score -= contractFines;
            stats.fines += contractFines;
            document.getElementById('audit-screen').style.display = 'flex';
            let summary = `
                <div class="flex justify-between"><span>GROSS SALES</span><span class="text-emerald-400">+$${stats.revenue}</span></div>
                <div class="flex justify-between text-red-400"><span>MISMATCH LOSS</span><span>-$${Math.floor(stats.penalty)}</span></div>
                <div class="flex justify-between text-red-400"><span>PENALTIES & BREACHES</span><span>-$${stats.fines}</span></div>
                <div class="border-t border-slate-700 pt-2 font-black text-lg"><span>TOTAL CAPITAL</span><span>$${Math.floor(score)}</span></div>
            `;
            if(currentRound === 0) summary += `<div class="mt-4 p-3 bg-indigo-500/20 text-indigo-400 text-xs rounded-lg uppercase font-black">Trial Complete. Data will reset for Round 1.</div>`;
            document.getElementById('audit-details').innerHTML = summary;
            if (db) {
                try { await addDoc(collection(db, "leaderboard"), { op: opName, score, round: currentRound }); } catch(e) {}
            }
            saveGame();
        }

        function checkAutoLoad() {
            if (loadGame() && opName) {
                document.getElementById('start-screen').style.display = 'none';
                active = true;
                spawnLogic();
                spawnContract();
                renderVendors();
                updateBuildPrice();
                render();
            }
        }
        
        renderVendors();
        checkAutoLoad();

    </script>
</body>

</html>
